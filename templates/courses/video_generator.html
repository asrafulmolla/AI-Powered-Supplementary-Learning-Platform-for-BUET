{% extends 'base.html' %}

{% block content %}
<div style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
    <!-- Page Header -->
    <div
        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4rem; position: relative; z-index: 10;">
        <div style="max-width: 600px;">
            <div
                style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; background: #fff1f2; color: var(--primary); border-radius: 100px; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1.5rem;">
                <i class="ri-movie-2-line"></i> Dynamic Storyboarding
            </div>
            <h1
                style="font-size: 3rem; font-weight: 800; color: var(--text-main); line-height: 1.1; margin-bottom: 1.5rem;">
                AI-Driven Video <span
                    style="background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">Symphony</span>
            </h1>
            <p style="color: var(--text-muted); font-size: 1.2rem; line-height: 1.6;">Transform complex academic textual
                content into structured cinematic video scripts for lecture summaries.</p>
        </div>
        <div
            style="width: 250px; height: 250px; background: radial-gradient(circle, rgba(116,30,30,0.05) 0%, rgba(116,30,30,0) 70%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <i class="ri-vidicon-line" style="font-size: 8rem; color: #f1f5f9;"></i>
        </div>
    </div>

    <!-- Configuration Card -->
    <div class="card"
        style="padding: 3rem; border-radius: 35px; background: white; border: 1px solid var(--border-color); box-shadow: 0 30px 60px rgba(0,0,0,0.05); margin-bottom: 4rem;">
        <div style="display: grid; grid-template-columns: 1fr 280px; gap: 2rem; align-items: flex-end;">
            <div>
                <label
                    style="display: block; font-size: 0.9rem; font-weight: 800; color: var(--text-main); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 1px;">Scientific
                    Concept or Lecture Topic</label>
                <div style="position: relative;">
                    <i class="ri-search-2-line"
                        style="position: absolute; left: 1.5rem; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 1.2rem;"></i>
                    <input type="text" id="video-topic"
                        placeholder="e.g. Asymptotic Notation, Operating System Deadlocks..."
                        style="width: 100%; padding: 1.5rem 1.5rem 1.5rem 3.5rem; border-radius: 20px; border: 2px solid #f1f5f9; background: #f8fafc; font-size: 1.1rem; outline: none; transition: all 0.3s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);">
                </div>
            </div>
            <button id="generate-video-btn" class="btn-primary"
                style="height: 68px; border-radius: 20px; font-size: 1.1rem; font-weight: 800; background: var(--text-main); border: none; box-shadow: 0 15px 25px rgba(0,0,0,0.1);">
                <i class="ri-play-list-add-line"></i> Generate Script
            </button>
        </div>
    </div>

    <!-- Result Area -->
    <div id="video-result" style="display: none;">
        <div
            style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding: 0 1rem;">
            <div>
                <h2 id="vid-title" style="font-size: 1.8rem; font-weight: 800; color: var(--primary);">Operating Systems
                    101</h2>
                <div id="vid-duration" style="font-size: 0.9rem; color: #64748b; font-weight: 600; margin-top: 4px;">
                    EST. DURATION: 2:45 MIN</div>
            </div>
            <button id="export-storyboard-btn" class="btn-primary"
                style="background: white; color: var(--text-main); border: 2px solid #e2e8f0; box-shadow: none;">
                <i class="ri-file-download-line"></i> Export Storyboard
            </button>
        </div>

        <div id="scenes-container" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
            <!-- Scenes will be injected here -->
        </div>
    </div>

    <!-- Progress Placeholder -->
    <div id="video-loading" style="display: none; text-align: center; padding: 5rem 0;">
        <div class="vid-loader"></div>
        <h3 style="margin-top: 2rem; color: #94a3b8;">Analyzing course context and building scenes...</h3>
    </div>
</div>

<style>
    .vid-loader {
        width: 60px;
        height: 60px;
        background: var(--primary);
        margin: 0 auto;
        animation: vid-pulse 1.2s infinite ease-in-out;
        border-radius: 15px;
    }

    @keyframes vid-pulse {
        0% {
            transform: scale(0.8);
            opacity: 0.5;
            border-radius: 15px;
        }

        50% {
            transform: scale(1.2);
            opacity: 1;
            border-radius: 30px;
        }

        100% {
            transform: scale(0.8);
            opacity: 0.5;
            border-radius: 15px;
        }
    }

    .scene-card {
        background: white;
        border: 1px solid #f1f5f9;
        border-radius: 24px;
        padding: 2rem;
        display: grid;
        grid-template-columns: 100px 1fr 1.5fr;
        gap: 3rem;
        align-items: flex-start;
        transition: all 0.3s;
    }

    .scene-card:hover {
        transform: translateX(10px);
        border-color: var(--primary);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
    }

    .scene-meta-label {
        font-size: 0.65rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #94a3b8;
        margin-bottom: 0.5rem;
    }
</style>

<script>
    let lastGeneratedData = null;

    document.getElementById('generate-video-btn').addEventListener('click', async () => {
        const topic = document.getElementById('video-topic').value;
        if (!topic) return;

        const btn = document.getElementById('generate-video-btn');
        const resultArea = document.getElementById('video-result');
        const loadingState = document.getElementById('video-loading');
        const scenesContainer = document.getElementById('scenes-container');

        btn.disabled = true;
        btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Processing...';
        resultArea.style.display = 'none';
        loadingState.style.display = 'block';

        try {
            const response = await fetch('/api/video-script/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ topic })
            });

            const data = await response.json();
            lastGeneratedData = data;

            document.getElementById('vid-title').textContent = data.title;
            document.getElementById('vid-duration').textContent = `EST. DURATION: ${data.duration}`;

            scenesContainer.innerHTML = '';
            data.scenes.forEach((scene, index) => {
                const sceneDiv = document.createElement('div');
                sceneDiv.className = 'scene-card';

                sceneDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div class="scene-meta-label">SCENE ${index + 1}</div>
                        <div style="font-size: 1.2rem; font-weight: 800; color: var(--primary); padding: 10px; background: #fff1f2; border-radius: 12px;">${scene.time}</div>
                    </div>
                    <div>
                        <div class="scene-meta-label">Visual Direction</div>
                        <p style="font-size: 0.95rem; line-height: 1.6; color: var(--text-main);">${scene.visual}</p>
                    </div>
                    <div style="padding: 1.5rem; background: #f8fafc; border-radius: 18px; border-left: 4px solid var(--secondary);">
                        <div class="scene-meta-label" style="color: var(--secondary);">Voiceover Content</div>
                        <p style="font-size: 0.95rem; line-height: 1.6; font-style: italic; color: #475569;">"${scene.audio}"</p>
                    </div>
                `;
                scenesContainer.appendChild(sceneDiv);
            });

            loadingState.style.display = 'none';
            resultArea.style.display = 'block';
            window.scrollTo({ top: resultArea.offsetTop - 100, behavior: 'smooth' });

        } catch (error) {
            alert('Generation error. Ensure your topic is related to course materials.');
            loadingState.style.display = 'none';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ri-play-list-add-line"></i> Generate Script';
        }
    });

    document.getElementById('export-storyboard-btn').addEventListener('click', () => {
        if (!lastGeneratedData) return;

        let content = `VIDEO STORYBOARD: ${lastGeneratedData.title}\n`;
        content += `ESTIMATED DURATION: ${lastGeneratedData.duration}\n`;
        content += `====================================================\n\n`;

        lastGeneratedData.scenes.forEach((scene, index) => {
            content += `SCENE ${index + 1} (${scene.time})\n`;
            content += `----------------------------------------------------\n`;
            content += `VISUAL: ${scene.visual}\n\n`;
            content += `VOICEOVER: "${scene.audio}"\n`;
            content += `\n\n`;
        });

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${lastGeneratedData.title.replace(/\s+/g, '_')}_storyboard.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
</script>
{% endblock %}